# ============================
# deploy_miner.yml
# ============================

- name: Triển khai công cụ đào CPU đơn giản
  hosts: miners
  become: yes
  vars_files:
    - mining_vars.yml

  tasks:
    - name: Cài các gói cần thiết (chỉ cho xmrig)
      apt:
        name:
          - git
          - curl
          - build-essential
          - cmake
          - libuv1-dev
          - libssl-dev
          - libhwloc-dev
        state: present
        update_cache: yes
      when: mining_tool == "xmrig"

    - name: Clone XMRig nếu chưa có
      git:
        repo: https://github.com/xmrig/xmrig.git
        dest: /opt/xmrig
        update: no
      when: mining_tool == "xmrig"

    - name: Tạo thư mục build
      file:
        path: /opt/xmrig/build
        state: directory
      when: mining_tool == "xmrig"

    - name: CMake xmrig
      command: cmake ..
      args:
        chdir: /opt/xmrig/build
      when: mining_tool == "xmrig"

    - name: Build xmrig
      command: make -j"{{ ansible_processor_cores | default(2) }}"
      args:
        chdir: /opt/xmrig/build
      when: mining_tool == "xmrig"

    - name: Copy xmrig vào /usr/local/bin
      copy:
        src: /opt/xmrig/build/xmrig
        dest: /usr/local/bin/xmrig
        mode: '0755'
        remote_src: yes
      when: mining_tool == "xmrig"

    - name: Tải tool SRBMiner
      unarchive:
        src: https://github.com/doktor83/SRBMiner-Multi/releases/download/2.9.2/SRBMiner-Multi-2-9-2-Linux.tar.gz
        dest: /opt/srbminer/
        remote_src: yes
      when: mining_tool == "srbminer"

    - name: Tải tool DeroLuna
      unarchive:
        src: https://github.com/DeroLuna/dero-miner/releases/download/v1.14/deroluna-v1.14_linux_hiveos_mmpos.tar.gz
        dest: /opt/dero/
        remote_src: yes
      when: mining_tool == "dero"

    - name: Tạo file config tool
      template:
        src: "{{ 'xmrig_config_template.json' if mining_tool == 'xmrig' else ( 'srbminer_config_template.txt' if mining_tool == 'srbminer' else 'dero_config_template.txt') }}"
        dest: "/opt/{{ mining_tool }}/{{ 'config.json' if mining_tool == 'xmrig' else 'config.txt' }}"
    - name: Tạo systemd service cho miner
      copy:
        dest: /etc/systemd/system/miner.service
        content: |
          [Unit]
          Description=Miner Service
          After=network.target

          [Service]
          ExecStart={{
            (mining_tool == 'xmrig') | ternary('/usr/local/bin/xmrig -c /opt/xmrig/config.json >> /var/log/xmrig.log 2>&1',
            (mining_tool == 'srbminer') | ternary('/opt/srbminer/SRBMiner-MULTI --config /opt/srbminer/config.txt >> /var/log/srbminer.log 2>&1',
            '/opt/dero/dero-miner --config /opt/dero/config.txt >> /var/log/dero.log 2>&1') )
          }}
          Restart=always
          RestartSec=10

          [Install]
          WantedBy=multi-user.target

    - name: Bật và khởi động miner.service
      systemd:
        name: miner
        enabled: yes
        state: restarted
